<!DOCTYPE html>
<html>
  <head>
    <title>FSM</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.css" type="text/css">
    <style>
      
        body {
  font-family: "Helvetica Neue", Helvetica, Arial, Sans-Serif;
  margin: 0;
}

h1 {
  font-size: 2.0em; font-weight: bold; text-align: center;
  color: white; background-color: black;
  padding: 5px 0;
  margin: 0 0 20px;
}

h2 {
  text-align: center;
  display: none;
  font-size: 0.5em;
}

.clearfix {display: inline-block; }
.input { overflow: show;}
.instruction { color: #666; padding: 0 30px 20px; font-size: 0.9em}
.instruction p { padding: 0 0 5px; }
.instruction li { padding: 0 10px 5px; }

.form { background: #EEE; padding: 20px 30px; border-radius: 5px; margin-left: auto; margin-right: auto; width: 500px; margin-bottom: 20px}
.form p, .form form { text-align: center }
.form form {padding: 0 10px 5px; }
.form .fun_routes { font-size: 0.9em;}
.form .fun_routes a { margin: 0 5px 0 0; }


      
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.4.8/d3.min.js" type="text/javascript"></script>
  </head>
  <body>
    <div id="wrapper">
      <h1>Routes FSM with NFA simulation</h1>
      <div class="instruction form">
        <p>
        Type a route in to the box and click "simulate".
        </p>
        <form onsubmit="return match(this.route.value);">
          <input type="text" size="30" name="route" value="/articles/new" />
          <button>simulate</button>
          <input type="reset" value="reset" onclick="return reset_graph();"/>
        </form>
        <p class="fun_routes">
          Some fun routes to try:
          
             <a href="#" onclick="document.forms[0].elements[0].value=this.text.replace(/^\s+|\s+$/g,''); return match(this.text.replace(/^\s+|\s+$/g,''));">
               /users/omg/omg
             </a>
          
        </p>
      </div>
      <div class='chart' id='chart-2'>
        <!-- Generated by graphviz version 2.40.1 (20161225.0304)
 -->
<!-- Title: nfa Pages: 1 -->
<svg  
 viewBox="0.00 0.00 690.96 52.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 48)">
<title>nfa</title>
<polygon fill="#ffffff" stroke="transparent" points="-4,4 -4,-48 686.9648,-48 686.9648,4 -4,4"/>
<!-- 6 -->
<g id="node1" class="node">
<title>6</title>
<ellipse fill="none" stroke="#000000" cx="660.9648" cy="-22" rx="18" ry="18"/>
<ellipse fill="none" stroke="#000000" cx="660.9648" cy="-22" rx="22" ry="22"/>
<text text-anchor="middle" x="660.9648" y="-17.8" font-family="Times,serif" font-size="14.00" fill="#000000">6</text>
</g>
<!-- 0 -->
<g id="node2" class="node">
<title>0</title>
<ellipse fill="none" stroke="#000000" cx="18" cy="-22" rx="18" ry="18"/>
<text text-anchor="middle" x="18" y="-17.8" font-family="Times,serif" font-size="14.00" fill="#000000">0</text>
</g>
<!-- 1 -->
<g id="node3" class="node">
<title>1</title>
<ellipse fill="none" stroke="#000000" cx="93.8896" cy="-22" rx="18" ry="18"/>
<text text-anchor="middle" x="93.8896" y="-17.8" font-family="Times,serif" font-size="14.00" fill="#000000">1</text>
</g>
<!-- 0&#45;&gt;1 -->
<g id="edge1" class="edge">
<title>0&#45;&gt;1</title>
<path fill="none" stroke="#000000" d="M36.3708,-22C45.1331,-22 55.8132,-22 65.581,-22"/>
<polygon fill="#000000" stroke="#000000" points="65.6881,-25.5001 75.6881,-22 65.688,-18.5001 65.6881,-25.5001"/>
<text text-anchor="middle" x="55.9448" y="-24.8" font-family="Times,serif" font-size="14.00" fill="#000000">/</text>
</g>
<!-- 2 -->
<g id="node4" class="node">
<title>2</title>
<ellipse fill="none" stroke="#000000" cx="194.6621" cy="-22" rx="18" ry="18"/>
<text text-anchor="middle" x="194.6621" y="-17.8" font-family="Times,serif" font-size="14.00" fill="#000000">2</text>
</g>
<!-- 1&#45;&gt;2 -->
<g id="edge2" class="edge">
<title>1&#45;&gt;2</title>
<path fill="none" stroke="#000000" d="M111.9057,-22C127.0019,-22 148.8208,-22 166.2652,-22"/>
<polygon fill="#000000" stroke="#000000" points="166.4623,-25.5001 176.4622,-22 166.4622,-18.5001 166.4623,-25.5001"/>
<text text-anchor="middle" x="144.2759" y="-24.8" font-family="Times,serif" font-size="14.00" fill="#000000">users</text>
</g>
<!-- 3 -->
<g id="node5" class="node">
<title>3</title>
<ellipse fill="none" stroke="#000000" cx="270.5518" cy="-22" rx="18" ry="18"/>
<text text-anchor="middle" x="270.5518" y="-17.8" font-family="Times,serif" font-size="14.00" fill="#000000">3</text>
</g>
<!-- 2&#45;&gt;3 -->
<g id="edge3" class="edge">
<title>2&#45;&gt;3</title>
<path fill="none" stroke="#000000" d="M213.0329,-22C221.7953,-22 232.4753,-22 242.2431,-22"/>
<polygon fill="#000000" stroke="#000000" points="242.3502,-25.5001 252.3502,-22 242.3501,-18.5001 242.3502,-25.5001"/>
<text text-anchor="middle" x="232.6069" y="-24.8" font-family="Times,serif" font-size="14.00" fill="#000000">/</text>
</g>
<!-- 4 -->
<g id="node6" class="node">
<title>4</title>
<ellipse fill="none" stroke="#000000" cx="425.8135" cy="-22" rx="18" ry="18"/>
<text text-anchor="middle" x="425.8135" y="-17.8" font-family="Times,serif" font-size="14.00" fill="#000000">4</text>
</g>
<!-- 3&#45;&gt;4 -->
<g id="edge5" class="edge">
<title>3&#45;&gt;4</title>
<path fill="none" stroke="#000000" d="M288.6661,-22C315.285,-22 365.2357,-22 396.9458,-22"/>
<polygon fill="#000000" stroke="#000000" points="397.3333,-25.5001 407.3332,-22 397.3332,-18.5001 397.3333,-25.5001"/>
<text text-anchor="middle" x="348.1826" y="-24.8" font-family="Times,serif" font-size="14.00" fill="#000000">(?&#45;mix:[^./?]+)</text>
</g>
<!-- 5 -->
<g id="node7" class="node">
<title>5</title>
<ellipse fill="none" stroke="#000000" cx="501.7031" cy="-22" rx="18" ry="18"/>
<text text-anchor="middle" x="501.7031" y="-17.8" font-family="Times,serif" font-size="14.00" fill="#000000">5</text>
</g>
<!-- 4&#45;&gt;5 -->
<g id="edge4" class="edge">
<title>4&#45;&gt;5</title>
<path fill="none" stroke="#000000" d="M444.1842,-22C452.9466,-22 463.6267,-22 473.3945,-22"/>
<polygon fill="#000000" stroke="#000000" points="473.5016,-25.5001 483.5015,-22 473.5015,-18.5001 473.5016,-25.5001"/>
<text text-anchor="middle" x="463.7583" y="-24.8" font-family="Times,serif" font-size="14.00" fill="#000000">/</text>
</g>
<!-- 5&#45;&gt;6 -->
<g id="edge6" class="edge">
<title>5&#45;&gt;6</title>
<path fill="none" stroke="#000000" d="M519.9725,-22C546.3989,-22 595.7022,-22 628.4333,-22"/>
<polygon fill="#000000" stroke="#000000" points="628.8411,-25.5001 638.8411,-22 628.8411,-18.5001 628.8411,-25.5001"/>
<text text-anchor="middle" x="579.334" y="-24.8" font-family="Times,serif" font-size="14.00" fill="#000000">(?&#45;mix:[^./?]+)</text>
</g>
</g>
</svg>

      </div>
      <div class="instruction">
        <p>
        This is a FSM for a system that has the following routes:
        </p>
        <ul>
          
            <li>/users/:name/:sneaky</li>
          
        </ul>
      </div>
    </div>
    
      <script>function tt() { return {"regexp_states":{"3":{"[^\\./\\?]+":4},"5":{"[^\\./\\?]+":6}},"string_states":{"0":{"/":1},"1":{"users":2},"2":{"/":3},"4":{"/":5}},"accepting":{"6":true}}; }</script>
    
      <script>function tokenize(input, callback) {
  while(input.length > 0) {
    callback(input.match(/^[\/\.\?]|[^\/\.\?]+/)[0]);
    input = input.replace(/^[\/\.\?]|[^\/\.\?]+/, '');
  }
}

var graph = d3.select("#chart-2 svg");
var svg_edges = {};
var svg_nodes = {};

graph.selectAll("g.edge").each(function() {
  var node  = d3.select(this);
  var index = node.select("title").text().split("->");
  var left  = parseInt(index[0]);
  var right = parseInt(index[1]);

  if(!svg_edges[left]) { svg_edges[left] = {} }
  svg_edges[left][right] = node;
});

graph.selectAll("g.node").each(function() {
  var node  = d3.select(this);
  var index = parseInt(node.select("title").text());
  svg_nodes[index] = node;
});

function reset_graph() {
  for(var key in svg_edges) {
    for(var mkey in svg_edges[key]) {
      var node = svg_edges[key][mkey];
      var path = node.select("path");
      var arrow = node.select("polygon");
      path.style("stroke", "black");
      arrow.style("stroke", "black").style("fill", "black");
    }
  }

  for(var key in svg_nodes) {
    var node = svg_nodes[key];
    node.select('ellipse').style("fill", "white");
    node.select('polygon').style("fill", "white");
  }
  return false;
}

function highlight_edge(from, to) {
  var node = svg_edges[from][to];
  var path = node.select("path");
  var arrow = node.select("polygon");

  path
    .transition().duration(500)
    .style("stroke", "green");

  arrow
    .transition().duration(500)
    .style("stroke", "green").style("fill", "green");
}

function highlight_state(index, color) {
  if(!color) { color = "green"; }

  svg_nodes[index].select('ellipse')
    .style("fill", "white")
    .transition().duration(500)
    .style("fill", color);
}

function highlight_finish(index) {
  svg_nodes[index].select('polygon')
    .style("fill", "while")
    .transition().duration(500)
    .style("fill", "blue");
}

function match(input) {
  reset_graph();
  var table         = tt();
  var states        = [0];
  var regexp_states = table['regexp_states'];
  var string_states = table['string_states'];
  var accepting     = table['accepting'];

  highlight_state(0);

  tokenize(input, function(token) {
    var new_states = [];
    for(var key in states) {
      var state = states[key];

      if(string_states[state] && string_states[state][token]) {
        var new_state = string_states[state][token];
        highlight_edge(state, new_state);
        highlight_state(new_state);
        new_states.push(new_state);
      }

      if(regexp_states[state]) {
        for(var key in regexp_states[state]) {
          var re = new RegExp("^" + key + "$");
          if(re.test(token)) {
            var new_state = regexp_states[state][key];
            highlight_edge(state, new_state);
            highlight_state(new_state);
            new_states.push(new_state);
          }
        }
      }
    }

    if(new_states.length == 0) {
      return;
    }
    states = new_states;
  });

  for(var key in states) {
    var state = states[key];
    if(accepting[state]) {
      for(var mkey in svg_edges[state]) {
        if(!regexp_states[mkey] && !string_states[mkey]) {
          highlight_edge(state, mkey);
          highlight_finish(mkey);
        }
      }
    } else {
      highlight_state(state, "red");
    }
  }

  return false;
}

</script>
    
  </body>
</html>
